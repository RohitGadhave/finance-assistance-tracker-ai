<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
        <%= title %>
    </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="assets/styles.css">
</head>

<body>
    <div class="container">
        <div class="app-container">
            <div class="sidebar">
                <div class="logo">
                    <i class="fas fa-robot"></i>
                    <span>AI Finance BABA</span>
                </div>
                <button id="new-chat-prompt" class="new-chat-btn">
                    <i class="fas fa-plus"></i>
                    <span>New Chat prompt</span>
                </button>
                <button id="new-chat" class="new-chat-btn">
                    <i class="fas fa-plus"></i>
                    <span>New Chat</span>
                </button>
                <div class="history-container">
                    <h3>Chat History</h3>
                    <div id="chat-history"></div>
                </div>
                <div class="settings">
                    <button id="clear-history">
                        <i class="fas fa-trash"></i>
                        <span>Clear History</span>
                    </button>
                    <button id="toggle-theme">
                        <i class="fas fa-moon"></i>
                        <span>Dark Mode</span>
                    </button>
                </div>
            </div>
            <div class="chat-container">
                <div class="chat-header">
                    <div class="current-chat-title" id="current-chat-title">
                        New Conversation
                    </div>
                    <div class="header-actions">
                        <span>
                            <%= user?.username %>
                        </span>
                        <button id="regenerate-response" title="Regenerate response">
                            <i class="fas fa-sync"></i>
                        </button>
                        <button id="stop-response" title="Stop generating" style="display: none">
                            <i class="fas fa-stop"></i>
                        </button>
                        <button id="export-chat" title="Export conversation">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div class="messages" id="messages">
                    <div class="intro-message">
                        <h1>Welcome to NeoChat AI</h1>
                        <p>Ask me anything. I'm powered by deepseek-r1.</p>
                        <div class="suggestion-chips">
                            <button class="suggestion-chip">Tell me a story</button>
                            <button class="suggestion-chip">
                                Explain quantum computing
                            </button>
                            <button class="suggestion-chip">Write a poem</button>
                            <button class="suggestion-chip">
                                Help me learn JavaScript
                            </button>
                        </div>
                    </div>
                </div>
                <div class="input-area">
                    <div class="input-container">
                        <button id="file-upload-button" title="Upload File">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <input type="file" id="file-upload" style="display: none" />
                        <textarea id="user-input" placeholder="Type your message here..." rows="1"></textarea>
                        <button id="send-button" title="Send message">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <!-- Pending file preview container -->
                    <div id="pending-file-preview"></div>
                    <div class="disclaimer">
                        NeoChat may produce inaccurate information. Messages are stored
                        locally.
                    </div>
                </div>
            </div>
        </div>
    </div>
    <% if (userLoggedIn) { %>
        <script src="assets/index.js"></script>
        <script type="module">
            import { setTValue,getData, postData } from "/assets/apiClient.js";
            setTValue("<%= csrfToken %>");
            document.addEventListener("DOMContentLoaded", () => {
                const newChatButton = document.getElementById("new-chat-prompt");

                async function openNewChatPrompt(e) {
                    e.stopPropagation();
                    const title = prompt("Enter new name for this chat:", '');
                    if (title) {
                        const topics = await postData("/topics/", { title });
                        // alert(title);
                    }
                }
                // Set up event listeners
                newChatButton.addEventListener("click", openNewChatPrompt);

            });
        </script>

        <% } else { %>

            <div id="signup-overlay" class="modal-overlay" role="presentation">
                <div id="signup-dialog" class="modal" role="dialog" aria-modal="true" aria-labelledby="signup-title"
                    tabindex="-1">
                    <div class="modal-header">
                        <h2 id="signup-title">Create account — Signup</h2>
                        <button class="modal-close" id="close-signup" aria-label="Close signup dialog">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="modal-body">
                        <form id="signup-form" class="signup-form" novalidate action="/user" method="POST">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <div class="input-group">
                                <label class="input-label" for="email">Email address</label>
                                <input id="email" class="email-input" name="email" type="email" inputmode="email"
                                    placeholder="you@domain.com" required aria-required="true" autocomplete="email" />
                                <div id="email-error" style="color:#d9534f; font-size:13px; display:none;">Please enter
                                    a valid
                                    email.</div>
                            </div>

                            <div class="form-actions">
                                <!-- <button type="button" class="btn btn-ghost" id="cancel-btn">Cancel</button> -->
                                <button type="submit" class="btn btn-primary" id="submit-btn">Continue</button>
                            </div>

                            <div id="success" class="success-msg">Thanks — check your inbox for a confirmation link
                                (demo).
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    const overlay = document.getElementById('signup-overlay');
                    const dialog = document.getElementById('signup-dialog');
                    // const openBtn = document.getElementById('open-signup');
                    const closeBtn = document.getElementById('close-signup');
                    const cancelBtn = document.getElementById('cancel-btn');
                    const form = document.getElementById('signup-form');
                    const emailInput = document.getElementById('email');
                    const emailError = document.getElementById('email-error');
                    const success = document.getElementById('success');

                    function openDialog() {
                        overlay.classList.add('is-open');
                        // focus the email input for accessibility
                        setTimeout(() => emailInput.focus(), 80);
                        // trap focus could be added later; this is a simple friendly dialog
                    }

                    function closeDialog() {
                        // overlay.classList.remove('is-open');
                        // emailError.style.display = 'none';
                        // success.style.display = 'none';
                        // form.reset();
                        // openBtn.focus();
                    }

                    // Open handlers
                    // openBtn.addEventListener('click', openDialog);

                    // Close handlers
                    // closeBtn.addEventListener('click', closeDialog);
                    // cancelBtn.addEventListener('click', closeDialog);

                    // Close when clicking outside modal content
                    //   overlay.addEventListener('click', (e) => {
                    //     if (e.target === overlay) closeDialog();
                    //   });

                    // Close on Escape
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && overlay.classList.contains('is-open')) {
                            closeDialog();
                        }
                    });

                    // Basic email validation and submit demo
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const val = emailInput.value.trim();
                        // simple regex for demo
                        const emailRx = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!emailRx.test(val)) {
                            emailError.style.display = 'block';
                            emailInput.focus();
                            return;
                        }
                        emailError.style.display = 'none';

                        const csrfToken = document.querySelector('input[name="_csrf"]').value;

                        const res = await fetch('/api/user', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'CSRF-Token': csrfToken // For csurf in "header" mode
                            },
                            body: JSON.stringify({ email: val })
                        });

                        if (res.ok) {
                            success.style.display = 'block';
                            window.location.reload();
                        } else {
                            alert('Error submitting form');
                        }
                        // If you want to auto-close after success, uncomment:
                        // setTimeout(closeDialog, 1400);
                    });
                    openDialog();

                });
            </script>
            <% } %>

</body>

</html>